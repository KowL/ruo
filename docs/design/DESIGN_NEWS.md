## 新闻模块设计

### 1. 整体功能架构

系统分为：**任务调度层**、**数据采集层**、**数据清洗层**和**持久化存储层**。

---

### 2. 详细功能流程

#### 2.1 任务调度流程 (Celery Beat)
由 Celery Beat 担任“司令官”，根据预设频率将抓取任务推送至消息队列（Redis）：
1.  **财联社实时任务**：每 60 秒触发一次（侧重时效性）。
2.  **雪球快讯任务**：每 120 秒触发一次（侧重社区和综合快讯）。
3.  **Cookie 刷新任务**：每 1 小时触发一次，模拟登录雪球以更新抓取所需的 Token。

#### 2.2 数据采集流程 (Celery Workers)
Worker 接收到任务后，执行具体的爬虫逻辑：
*   **财联社采集逻辑**：
    1.  访问财联社电报 API（`telegraphList`）。
    2.  提取字段：唯一 ID、标题、正文、发布时间戳。
*   **雪球采集逻辑**：
    1.  从 Redis 获取最新的 `xq_a_token`。
    2.  访问雪球 7x24 快讯或动态 API。
    3.  提取字段：帖子 ID、用户/来源信息、文本内容、发布时间。

#### 2.3 数据清洗与去重流程
这是确保数据库数据质量的关键步骤：
1.  **格式标准化**：将不同平台的时间戳统一为 ISO 8601 格式，将 HTML 标签去除，仅保留纯文本。
2.  **冲突检测**：
    *   **硬去重**：利用 PostgreSQL 的 `UNIQUE` 约束（`source` + `external_id`），防止同一条新闻被重复写入。
    *   **软去重（可选）**：通过计算新闻内容的 MD5 哈希值，识别不同来源但内容高度相似的冗余快讯。

#### 2.4 持久化流程 (PostgreSQL)
数据进入数据库前的处理：
1.  **初始状态标记**：新闻存入 `news_items` 表，初始状态标记为 `pending`（待后续处理）。
2.  **关联索引**：对 `publish_time` 和 `source` 建立索引，方便后续按时间维度检索。

---

### 3. 数据库设计 (PostgreSQL)

为了支持上述流程，设计如下表结构：

#### 3.1 原始新闻表 (`raw_news`)
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | SERIAL | 自增主键 |
| `source` | VARCHAR(20) | 来源 (cls / xueqiu) |
| `external_id` | VARCHAR(100) | 原始平台 ID (用于唯一性校验) |
| `title` | VARCHAR(500) | 新闻标题 (部分快讯可能无标题) |
| `content` | TEXT | 新闻正文内容 |
| `raw_json` | JSONB | 存储原始响应数据 (备查) |
| `publish_time` | TIMESTAMP | 原始发布时间 |
| `created_at` | TIMESTAMP | 系统入库时间 |

---

### 4. 关键保障机制设计

#### 4.1 动态 Token 管理 (针对雪球)
*   由于雪球有较严的反爬机制，设计一个独立的 **Token 更新任务**。
*   该任务使用自动化工具（如 Playwright 或 Selenium）启动无头浏览器，模拟访问雪球首页。
*   截获 Cookie 中的 `xq_a_token` 并存入 Redis，供其他爬虫任务读取。

#### 4.2 异常重试与告警
*   **重试机制**：利用 Celery 的 `autoretry_for` 功能，针对网络波动（502/504 错误）进行指数退避重试。
*   **错误捕获**：如果连续 N 次采集失败，触发告警（如发送至钉钉/邮件），通知维护人员检查接口是否变动。

#### 4.3 流量控制 (Rate Limiting)
*   在 Celery 中配置 `task_rate_limit`。
*   财联社和雪球对高频访问敏感，建议设置单 Worker 每分钟请求次数限制，配合代理 IP 池轮询，降低封 IP 风险。

---

### 5. 功能流转图总结

1.  **[Beat]** 定时发送任务 -> **[Redis Queue]**
2.  **[Worker]** 获取任务 -> **[Proxy Pool]** 获取 IP -> **[Target API]** 抓取
3.  **[Worker]** 提取 `xq_a_token` (雪球专用) -> **[Data Cleaning]** 清洗格式
4.  **[Worker]** 检查数据库唯一性 -> **[PostgreSQL]** 执行 `INSERT ON CONFLICT DO NOTHING`
5.  **[DB]** 数据就绪，等待后续应用（如推送、搜索或 AI 分析）
6.  
